<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>User Dashboard — TaskManager</title>

  <!-- root-based paths that match router.Static("/assets", ...) -->
  <link rel="stylesheet" href="/assets/css/base.css">
  <link rel="stylesheet" href="/assets/css/user.css">
</head>

<body>
  <div class="container">

    <!-- Top bar -->
    <div id="top" class="card row" style="justify-content: space-between; align-items: center;">
      <div>
        <h2>User Dashboard</h2>
        <div id="userInfo" class="small"></div>
      </div>
      <button id="btnLogout" class="btn">Logout</button>
    </div>

    <!-- Content -->
    <div class="card user-grid" style="margin-top:16px">
      <div>
        <h3>Your Tasks</h3>
        <div id="tasksList" class="list"></div>
      </div>

      <aside>
        <h3>Your Projects</h3>
        <div id="projectsList"></div>
      </aside>
    </div>

  </div>

  <!-- primary module (keeps your app code modular) -->
  <script type="module" src="/pages/user/userDashboard.js"></script>

  <!-- fallback & robust logout handler (runs even if module fails to load) -->
  <script>
  (function() {
    const LOGIN_PATH = '/pages/auth/login.html';

    // attachLogout ensures exactly one handler is attached and logs actions
    function attachLogout() {
      const btn = document.getElementById('btnLogout');
      if (!btn) {
        console.warn('btnLogout not found — creating fallback button');
        const b = document.createElement('button');
        b.id = 'btnLogout';
        b.textContent = 'Logout';
        b.style.position = 'fixed';
        b.style.top = '12px';
        b.style.right = '12px';
        b.style.zIndex = 9999;
        document.body.appendChild(b);
        bind(b);
        return;
      }
      bind(btn);
    }

    function bind(el) {
      // remove any previous to avoid double handlers
      el.replaceWith(el.cloneNode(true));
      const newBtn = document.getElementById('btnLogout') || el;
      newBtn.addEventListener('click', async () => {
        console.log('Logout clicked — calling /api/logout');
        try {
          const res = await fetch('/api/logout', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Accept': 'application/json' },
          });

          if (!res.ok) {
            let body = '<no body>';
            try { body = await res.text(); } catch (e) {}
            console.warn('Logout returned non-OK:', res.status, body);
          } else {
            console.log('Logout OK:', res.status);
          }
        } catch (err) {
          console.error('Network error calling /api/logout:', err);
        } finally {
          // redirect in all cases
          window.location.href = LOGIN_PATH;
        }
      }, { once: true });
    }

    // Run after DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', attachLogout);
    } else {
      attachLogout();
    }
  })();
  </script>

  <noscript>
    <div style="padding: 20px; color: red; font-weight: bold;">
      JavaScript is required to use the dashboard.
    </div>
  </noscript>
</body>
</html>
